<% set_meta_tags title: ['Admin', 'Email Log', @email.subject.presence || 'Email Details'] %>

<div class="mb-3">
  <%= link_to mailer_log_engine.admin_emails_path, class: 'btn btn-outline-secondary btn-sm' do %>
    <i class="far fa-arrow-left"></i> Back to Email Log
  <% end %>
</div>

<div class="card card-border-color card-border-color-dark card-default">
  <div class="card-header">
    <span class="title"><%= @email.subject.presence || '(no subject)' %></span>
    <% status_class = case @email.status
       when 'delivered', 'opened', 'clicked' then 'success'
       when 'bounced', 'complained' then 'danger'
       when 'sent' then 'info'
       else 'secondary'
       end %>
    <span class="badge badge-<%= status_class %> float-right"><%= @email.status %></span>
  </div>
  <div class="card-body">
    <div class="row mb-4">
      <div class="col-md-6">
        <dl class="row">
          <dt class="col-sm-3">From</dt>
          <dd class="col-sm-9"><code><%= @email.from_address %></code></dd>

          <dt class="col-sm-3">To</dt>
          <dd class="col-sm-9"><code><%= @email.to_addresses.join(', ') %></code></dd>

          <% if @email.cc_addresses.present? %>
            <dt class="col-sm-3">CC</dt>
            <dd class="col-sm-9"><code><%= @email.cc_addresses.join(', ') %></code></dd>
          <% end %>

          <% if @email.bcc_addresses.present? %>
            <dt class="col-sm-3">BCC</dt>
            <dd class="col-sm-9"><code><%= @email.bcc_addresses.join(', ') %></code></dd>
          <% end %>

          <dt class="col-sm-3">Mailer</dt>
          <dd class="col-sm-9">
            <code><%= @email.mailer_class %>#<%= @email.mailer_action %></code>
          </dd>

          <dt class="col-sm-3">Message ID</dt>
          <dd class="col-sm-9">
            <code class="small"><%= @email.message_id %></code>
          </dd>

          <dt class="col-sm-3">Sent At</dt>
          <dd class="col-sm-9"><%= @email.created_at.strftime('%Y-%m-%d %H:%M:%S %Z') %></dd>

          <% if @email.delivered_at %>
            <dt class="col-sm-3">Delivered</dt>
            <dd class="col-sm-9"><%= @email.delivered_at.strftime('%Y-%m-%d %H:%M:%S %Z') %></dd>
          <% end %>

          <% if @email.opened_at %>
            <dt class="col-sm-3">Opened</dt>
            <dd class="col-sm-9"><%= @email.opened_at.strftime('%Y-%m-%d %H:%M:%S %Z') %></dd>
          <% end %>

          <% if @email.clicked_at %>
            <dt class="col-sm-3">Clicked</dt>
            <dd class="col-sm-9"><%= @email.clicked_at.strftime('%Y-%m-%d %H:%M:%S %Z') %></dd>
          <% end %>

          <% if @email.domain.present? %>
            <dt class="col-sm-3">Domain</dt>
            <dd class="col-sm-9"><code><%= @email.domain %></code></dd>
          <% end %>
        </dl>
      </div>

      <div class="col-md-6">
        <h6>Delivery Events</h6>
        <% if @email.events.any? %>
          <table class="table table-sm table-bordered">
            <thead class="thead-light">
              <tr>
                <th>Event</th>
                <th>Time</th>
                <th>Recipient</th>
              </tr>
            </thead>
            <tbody>
              <% @email.events.recent.each do |event| %>
                <tr>
                  <td>
                    <span class="badge badge-<%= event.event_type == 'delivered' ? 'success' : 'secondary' %>">
                      <%= event.event_type %>
                    </span>
                  </td>
                  <td class="small"><%= event.occurred_at&.strftime('%H:%M:%S') %></td>
                  <td class="small"><%= event.recipient %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <p class="text-muted small">No delivery events recorded yet.</p>
        <% end %>
      </div>
    </div>

    <h5>Email Preview</h5>
    <% if @email.html_body.present? %>
      <iframe src="<%= mailer_log_engine.preview_admin_email_path(@email) %>"
              class="mailer-log-email-preview"></iframe>
    <% elsif @email.text_body.present? %>
      <pre class="bg-light p-3 mailer-log-scrollable-content"><%= @email.text_body %></pre>
    <% else %>
      <p class="text-muted">No email body available.</p>
    <% end %>

    <% if @email.call_stack.present? %>
      <h5 class="mt-4">Call Stack</h5>
      <details>
        <summary class="btn btn-sm btn-outline-secondary mb-2">Show call stack</summary>
        <pre class="bg-light p-3 small mailer-log-scrollable-content-sm"><%= @email.call_stack %></pre>
      </details>
    <% end %>

    <% if @email.headers.present? %>
      <h5 class="mt-4">Headers</h5>
      <details>
        <summary class="btn btn-sm btn-outline-secondary mb-2">Show headers</summary>
        <pre class="bg-light p-3 small mailer-log-scrollable-content-sm"><%= JSON.pretty_generate(@email.headers) %></pre>
      </details>
    <% end %>
  </div>
</div>
